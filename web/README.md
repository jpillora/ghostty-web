# How ghostty-web Works

ghostty-web is a web-based terminal emulator that compiles [Ghostty](https://github.com/ghostty-org/ghostty)'s VT100 parser to WebAssembly and wraps it with a TypeScript API compatible with [xterm.js](https://github.com/xtermjs/xterm.js).

## Project Structure

```
ghostty-web/
  ghostty/                 # Git submodule — full Ghostty source tree
  patches/
    ghostty-wasm-api.patch # Adds a terminal emulator C API to Ghostty's lib-vt
  scripts/
    build-wasm.sh          # Applies patch, builds WASM, reverts patch
  ghostty-vt.wasm          # Pre-built WASM binary (~424 KB, committed)
  lib/                     # TypeScript source
    index.ts               # Public API entry point
    terminal.ts            # Main Terminal class (xterm.js-compatible)
    ghostty.ts             # WASM bridge (loads module, wraps C functions)
    renderer.ts            # Canvas 2D renderer (60 FPS, dirty-line tracking)
    input-handler.ts       # Keyboard events → terminal escape sequences
    selection-manager.ts   # Mouse selection + clipboard
    types.ts               # TypeScript mirrors of the C ABI structs/enums
    buffer.ts              # xterm.js-compatible Buffer API
    interfaces.ts          # xterm.js-compatible interface definitions
    event-emitter.ts       # Simple pub/sub event emitter
    link-detector.ts       # Link hover/click detection system
    addons/
      fit.ts               # FitAddon — auto-sizes terminal to container
    providers/
      osc8-link-provider.ts    # OSC 8 hyperlink detection
      url-regex-provider.ts    # Regex-based URL detection
  demo/                    # Demo app (also published as @ghostty-web/demo)
    bin/demo.js            # HTTP + WebSocket PTY server (Node.js)
    index.html             # Interactive terminal demo page
  dist/                    # Build output (generated by Vite)
  vite.config.js           # Vite bundler config
  package.json             # npm package config
  flake.nix                # Nix dev shell (Bun + Node.js 22 + Zig 0.15.2)
```

## Architecture

```
Browser
┌──────────────────────────────────────────────────────────┐
│  Terminal  (lib/terminal.ts)                              │
│  xterm.js-compatible public API                          │
│                                                          │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────┐ │
│  │ Canvas      │  │ Input        │  │ Selection       │ │
│  │ Renderer    │  │ Handler      │  │ Manager         │ │
│  │ (renderer)  │  │ (input-      │  │ (selection-     │ │
│  │             │  │  handler)    │  │  manager)       │ │
│  └──────┬──────┘  └──────┬───────┘  └────────┬────────┘ │
│         │                │                    │          │
│  ┌──────┴────────────────┴────────────────────┴────────┐ │
│  │  WASM Bridge  (lib/ghostty.ts)                      │ │
│  │  Ghostty / GhosttyTerminal / KeyEncoder             │ │
│  └──────────────────────┬──────────────────────────────┘ │
│                         │ WASM function calls             │
│  ┌──────────────────────┴──────────────────────────────┐ │
│  │  ghostty-vt.wasm                                    │ │
│  │  Ghostty VT100 state machine + screen buffer        │ │
│  │  (compiled from Zig → wasm32-freestanding)          │ │
│  └─────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
```

### What runs in WASM (Ghostty)

- VT100/ANSI escape sequence parsing
- Screen buffer (2D cell grid with styles, colors, graphemes)
- Cursor tracking and movement
- Scrollback buffer
- SGR (Select Graphic Rendition) attribute parsing
- Key encoding (including Kitty keyboard protocol)
- Terminal modes (alternate screen, mouse tracking, bracketed paste, etc.)
- DSR/DA response generation

### What runs in TypeScript

- Terminal API surface (xterm.js drop-in compatibility)
- Canvas rendering (font metrics, text styles, cursor drawing)
- Keyboard event handling and translation
- Mouse selection and clipboard
- Addons (FitAddon for responsive sizing)
- Link detection (OSC 8 hyperlinks, URL regex)
- Event system (onData, onResize, onBell, etc.)

## Build Pipeline

### Prerequisites

- **Zig 0.15.2+** — compiles Ghostty to WASM
- **Bun** — runtime, test runner, package manager
- **Node.js 22** — for the demo server

Or use Nix: `nix develop` provides all of the above.

### Full Build

```bash
bun run build
```

This runs four stages:

1. **`clean`** — `rm -rf dist`
2. **`build:wasm`** — `./scripts/build-wasm.sh` (see below)
3. **`build:lib`** — `vite build` (bundles TypeScript → ES module + UMD)
4. **`build:wasm-copy`** — copies `ghostty-vt.wasm` into `dist/`

### WASM Build (`scripts/build-wasm.sh`)

The WASM binary is built from Ghostty's source with a temporary patch:

1. Initialize the `ghostty/` submodule if needed
2. Apply `patches/ghostty-wasm-api.patch` to the submodule
3. Run `zig build lib-vt -Dtarget=wasm32-freestanding -Doptimize=ReleaseSmall`
4. Copy `ghostty/zig-out/bin/ghostty-vt.wasm` to project root
5. Revert the patch and remove new files, leaving the submodule clean

The pre-built `ghostty-vt.wasm` is committed to the repo so TypeScript-only development does not require Zig.

### Library Build (Vite)

Vite bundles the TypeScript source from `lib/index.ts` into:

- `dist/ghostty-web.js` — ES module
- `dist/ghostty-web.umd.cjs` — UMD module
- `dist/index.d.ts` — rolled-up TypeScript declarations

Zero external dependencies — everything is self-contained.

## Data Flow

A typical frame looks like this:

1. **Input arrives** — PTY server sends bytes over WebSocket
2. **`terminal.write(data)`** — data is passed to WASM via `ghostty_terminal_write`
3. **WASM processes** — Ghostty's stream parser handles escape sequences, updates screen buffer
4. **Render state update** — `ghostty_render_state_update` returns dirty state (none/partial/full)
5. **Viewport read** — `ghostty_render_state_get_viewport` copies ALL cells (16 bytes each) to a TypeScript buffer in ONE call
6. **Canvas render** — renderer draws only dirty rows, resolving colors, styles, cursor, and selection
7. **Response check** — if the terminal generated DSR/DA responses, they're read via `ghostty_terminal_read_response` and emitted through `onData`

User keystrokes flow in reverse:

1. **KeyboardEvent** → InputHandler maps key code + modifiers
2. **KeyEncoder (WASM)** encodes to terminal escape sequence
3. **`onData` event** fires → app sends bytes to PTY server

## Cell Format

Each cell in the viewport is a 16-byte struct:

| Field          | Type   | Description                              |
|----------------|--------|------------------------------------------|
| `codepoint`    | u32    | Unicode codepoint (0 = empty)            |
| `fg_r/g/b`    | u8 x3  | Foreground color (pre-resolved to RGB)   |
| `bg_r/g/b`    | u8 x3  | Background color (pre-resolved to RGB)   |
| `flags`        | u8     | Bold, italic, underline, strikethrough, inverse, invisible, blink, faint |
| `width`        | u8     | 0=spacer, 1=narrow, 2=wide              |
| `hyperlink_id` | u16    | Non-zero if cell has a hyperlink         |
| `grapheme_len` | u8     | Extra codepoints beyond the first        |
| `_pad`         | u8     | Padding for alignment                   |

Colors are pre-resolved from palette indices to RGB during the viewport read, avoiding per-cell palette lookups on the TypeScript side.

## Development

```bash
bun install                   # Install dependencies
bun run dev                   # Start Vite dev server on http://localhost:8000
bun test                      # Run test suite
bun run typecheck             # TypeScript type checking
bun run fmt                   # Check formatting (Prettier)
bun run lint                  # Lint (Biome)
```

### Running the Demo

```bash
bun run demo                  # Start demo server on http://localhost:8080
```

Or for development with hot reload:

```bash
bun run demo:dev              # Demo server proxying to Vite dev server
```

### CI

Four parallel jobs: `fmt`, `lint`, `typecheck`, `test`+`build`. The build job rebuilds the WASM from source and enforces a 512 KB size limit.

## npm Publishing

Two packages are published:

- **`ghostty-web`** — the terminal library
- **`@ghostty-web/demo`** — the demo server

Tag pushes produce `latest` releases. Merges to `main` produce `next` pre-releases (e.g., `0.3.0-next.5.g1a2b3c4`).
